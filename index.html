<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>PLIX Viewer & Converter</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      text-align: center;
      padding: 20px;
    }
    #canvas {
      image-rendering: pixelated;
      border: 2px solid black;
      margin-top: 20px;
    }
    input {
      margin: 10px;
    }
  </style>
</head>
<body>
  <h1>üñºÔ∏è PLIX Viewer & Converter</h1>
  <input type="file" id="upload" accept=".plix,.png">
  <button onclick="downloadPlix()">Download .plix</button>
  <canvas id="canvas" width="100" height="100"></canvas>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const upload = document.getElementById('upload');

    let imageData;

    upload.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      if (file.name.endsWith('.plix')) {
        const text = await file.text();
        if (!text.trim().endsWith('@end')) {
          alert("Fejl: PLIX filen mangler @end!");
          return;
        }
        loadPlix(text);
      } else if (file.type === 'image/png') {
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        };
        img.src = URL.createObjectURL(file);
      }
    });

    function downloadPlix() {
      if (!imageData) {
        alert("Indl√¶s f√∏rst et PNG-billede.");
        return;
      }

      let lines = [];
      const width = imageData.width;
      const height = imageData.height;
      const data = imageData.data;

      for (let x = 0; x < width; x++) {
        let column = [];
        for (let y = 0; y < height; y++) {
          const yy = x % 2 === 0 ? y : height - 1 - y; // zigzag
          const i = (yy * width + x) * 4;
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          column.push(`{drawtype}=*rgb(${r},${g},${b})*`);
        }
        lines.push(...column);
      }

      lines.push('@end');

      const blob = new Blob([lines.join('‚Ç¨‚Ç¨')], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'converted.plix';
      link.click();
    }

    function loadPlix(plixText) {
      const entries = plixText.split('‚Ç¨‚Ç¨');
      const pixelData = entries.slice(0, -1); // remove @end
      const size = Math.sqrt(pixelData.length);
      canvas.width = canvas.height = size;
      const imgData = ctx.createImageData(size, size);

      let index = 0;
      for (let x = 0; x < size; x++) {
        for (let y = 0; y < size; y++) {
          const yy = x % 2 === 0 ? y : size - 1 - y;
          const i = (yy * size + x) * 4;
          const match = pixelData[index].match(/\*rgb\((\d+),(\d+),(\d+)\)\*/);
          if (match) {
            imgData.data[i] = +match[1];
            imgData.data[i + 1] = +match[2];
            imgData.data[i + 2] = +match[3];
            imgData.data[i + 3] = 255;
          }
          index++;
        }
      }

      ctx.putImageData(imgData, 0, 0);
    }
  </script>
</body>
</html>
