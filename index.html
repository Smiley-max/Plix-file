<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<title>PNG ⇄ PLIX Konverter</title>
<style>
  body {
    background: #121212;
    color: white;
    font-family: monospace, monospace;
    text-align: center;
    padding: 1rem;
  }
  canvas {
    border: 2px solid #0af;
    image-rendering: pixelated;
    margin: 1rem 0;
  }
  textarea {
    width: 90%;
    height: 150px;
    background: #222;
    color: #0af;
    font-family: monospace;
    margin-top: 1rem;
    padding: 0.5rem;
    border-radius: 8px;
  }
  input[type="file"] {
    margin: 0.5rem;
  }
</style>
</head>
<body>
  <h1>PNG ⇄ PLIX Konverter</h1>
  
  <label>Upload PNG:</label><br>
  <input type="file" id="pngInput" accept="image/png"><br>

  <label>Upload PLIX:</label><br>
  <input type="file" id="plixInput" accept=".plix"><br>

  <canvas id="canvas" width="100" height="100"></canvas><br>

  <button id="convertBtn">Konverter Canvas til PLIX</button><br>

  <textarea id="plixOutput" readonly placeholder="PLIX output vises her..."></textarea>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  let imageData = ctx.createImageData(width, height);

  function setPixel(x, y, r, g, b, a=255) {
    const idx = (y * width + x) * 4;
    imageData.data[idx] = r;
    imageData.data[idx+1] = g;
    imageData.data[idx+2] = b;
    imageData.data[idx+3] = a;
  }

  function drawImageData() {
    ctx.putImageData(imageData, 0, 0);
  }

  document.getElementById('pngInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0,0,width,height);
      ctx.drawImage(img, 0, 0, width, height);
      imageData = ctx.getImageData(0, 0, width, height);
      alert('PNG indlæst! Klik "Konverter Canvas til PLIX" for at lave .plix');
    };
    img.src = URL.createObjectURL(file);
  });

  document.getElementById('convertBtn').addEventListener('click', () => {
    let plixText = '';
    let goingDown = true;
    let x = 0, y = 0;

    for (let i=0; i < width*height; i++) {
      const idx = (y * width + x) * 4;
      const r = imageData.data[idx];
      const g = imageData.data[idx+1];
      const b = imageData.data[idx+2];
      const a = imageData.data[idx+3];

      let drawtype = '*x*';

      if (a === 0 || (r>240 && g>240 && b>240)) {
        drawtype = '*x*';
      } else {
        if (Math.abs(r-g) < 15 && Math.abs(r-b) < 15) {
          drawtype = '*pencil*';
        } else {
          const hex = toHex(r,g,b);
          drawtype = `*marker*<[${hex}]>`;
        }
      }

      plixText += `{drawtype}=${drawtype}€€`;

      if (goingDown) {
        y++;
        if (y >= height) {
          y = height - 1;
          x++;
          goingDown = false;
        }
      } else {
        y--;
        if (y < 0) {
          y = 0;
          x++;
          goingDown = true;
        }
      }
    }

    // Tilføj @end til sidst
    plixText += '@end';

    document.getElementById('plixOutput').value = plixText;
  });

  document.getElementById('plixInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const content = reader.result.trim();

      if (!content.endsWith('@end')) {
        alert('Fejl: .plix filen skal slutte med @end for at virke!');
        return;
      }

      const lines = content.split('€€');
      let x = 0, y = 0;
      let goingDown = true;

      for (let line of lines) {
        line = line.trim();
        if (!line || !line.includes('{drawtype}')) continue;

        const match = line.match(/\*([a-z]+)\*(?:<\[([0-9a-fA-F]{6})\]>)?/);
        if (!match) continue;

        const type = match[1];
        const hex = match[2];

        let r=255, g=255, b=255;

        if (type === 'x') {
          r = g = b = 255;
        } else if (type === 'pencil') {
          r = g = b = 100;
        } else if (type === 'colorpencil' || type === 'marker') {
          if (hex) {
            r = parseInt(hex.substring(0,2),16);
            g = parseInt(hex.substring(2,4),16);
            b = parseInt(hex.substring(4,6),16);
          }
        }

        setPixel(x,y,r,g,b);

        if (goingDown) {
          y++;
          if (y >= height) {
            y = height -1;
            x++;
            goingDown = false;
          }
        } else {
          y--;
          if (y < 0) {
            y=0;
            x++;
            goingDown = true;
          }
        }
      }

      drawImageData();
    };

    reader.readAsText(file);
  });

  function toHex(r,g,b) {
    return [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('');
  }
</script>
</body>
</html>
